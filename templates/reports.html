{% extends "base.html" %}

{% block title %}Reports - Smart Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar me-2"></i>Attendance Reports & Analytics
        </h1>
    </div>
</div>

<!-- Date Range Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Report Period
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-4">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ date_from }}">
                    </div>
                    <div class="col-md-4">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ date_to }}">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-chart-line me-1"></i>Generate Report
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setQuickRange('week')">
                            This Week
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-1" onclick="setQuickRange('month')">
                            This Month
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
{% if summary %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3>{{ summary.total_records }}</h3>
                <p class="mb-0">Total Records</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3>{{ summary.present_count }}</h3>
                <p class="mb-0">Present ({{ summary.present_percentage }}%)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h3>{{ summary.late_count }}</h3>
                <p class="mb-0">Late ({{ summary.late_percentage }}%)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <i class="fas fa-times-circle fa-2x mb-2"></i>
                <h3>{{ summary.absent_count }}</h3>
                <p class="mb-0">Absent ({{ summary.absent_percentage }}%)</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Attendance Overview Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-pie-chart me-2"></i>Attendance Overview
                </h5>
            </div>
            <div class="card-body">
                <canvas id="attendanceChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Department-wise Statistics -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-building me-2"></i>Department-wise Attendance
                </h5>
            </div>
            <div class="card-body">
                <canvas id="departmentChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Department Statistics Table -->
{% if dept_stats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Department-wise Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Total Records</th>
                                <th>Present</th>
                                <th>Late</th>
                                <th>Absent</th>
                                <th>Attendance Rate</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept, stats in dept_stats.items() %}
                            <tr>
                                <td>
                                    <span class="badge bg-primary">{{ dept }}</span>
                                </td>
                                <td>{{ stats.total }}</td>
                                <td>
                                    <span class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>{{ stats.present }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-warning">
                                        <i class="fas fa-clock me-1"></i>{{ stats.late }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-danger">
                                        <i class="fas fa-times-circle me-1"></i>{{ stats.absent }}
                                    </span>
                                </td>
                                <td>
                                    {% set attendance_rate = ((stats.present + stats.late) / stats.total * 100) if stats.total > 0 else 0 %}
                                    <div class="progress" style="width: 100px;">
                                        <div class="progress-bar bg-{{ 'success' if attendance_rate >= 80 else 'warning' if attendance_rate >= 60 else 'danger' }}" 
                                             role="progressbar" 
                                             style="width: {{ attendance_rate }}%"
                                             title="{{ '%.1f'|format(attendance_rate) }}%">
                                        </div>
                                    </div>
                                    <small>{{ '%.1f'|format(attendance_rate) }}%</small>
                                </td>
                                <td>
                                    {% if attendance_rate >= 80 %}
                                        <span class="badge bg-success">Excellent</span>
                                    {% elif attendance_rate >= 60 %}
                                        <span class="badge bg-warning">Good</span>
                                    {% else %}
                                        <span class="badge bg-danger">Needs Improvement</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Export Options -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>Export Reports
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Attendance Data</h6>
                        <p class="text-muted">Export raw attendance data for the selected period</p>
                        <div class="btn-group" role="group">
                            <button class="btn btn-success" onclick="alert('CSV export coming soon!')">
                                <i class="fas fa-file-csv me-1"></i>CSV Format
                            </button>
                            <button class="btn btn-primary" onclick="alert('Excel export coming soon!')">
                                <i class="fas fa-file-excel me-1"></i>Excel Format
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Summary Report</h6>
                        <p class="text-muted">Export summary statistics and analytics</p>
                        <div class="btn-group" role="group">
                            <button class="btn btn-info" onclick="exportSummaryPDF()">
                                <i class="fas fa-file-pdf me-1"></i>PDF Report
                            </button>
                            <button class="btn btn-warning" onclick="printReport()">
                                <i class="fas fa-print me-1"></i>Print Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
    // Initialize charts
    initializeCharts();
});

function initializeCharts() {
    // Attendance Overview Pie Chart
    const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(attendanceCtx, {
        type: 'doughnut',
        data: {
            labels: ['Present', 'Late', 'Absent'],
            datasets: [{
                data: [
                    {{ summary.present_count if summary else 0 }},
                    {{ summary.late_count if summary else 0 }},
                    {{ summary.absent_count if summary else 0 }}
                ],
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#dc3545'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Department-wise Bar Chart
    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
    
    {% if dept_stats %}
    const deptLabels = [{% for dept in dept_stats.keys() %}'{{ dept }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const deptData = [{% for stats in dept_stats.values() %}{{ ((stats.present + stats.late) / stats.total * 100) if stats.total > 0 else 0 }}{% if not loop.last %},{% endif %}{% endfor %}];
    {% else %}
    const deptLabels = [];
    const deptData = [];
    {% endif %}
    
    new Chart(departmentCtx, {
        type: 'bar',
        data: {
            labels: deptLabels,
            datasets: [{
                label: 'Attendance Rate (%)',
                data: deptData,
                backgroundColor: '#007bff',
                borderColor: '#0056b3',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function setQuickRange(period) {
    const today = new Date();
    let fromDate, toDate;
    
    if (period === 'week') {
        // Get start of current week (Monday)
        const dayOfWeek = today.getDay();
        const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        fromDate = new Date(today.setDate(diff));
        toDate = new Date();
    } else if (period === 'month') {
        // Get start of current month
        fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
        toDate = new Date();
    }
    
    $('#date_from').val(fromDate.toISOString().split('T')[0]);
    $('#date_to').val(toDate.toISOString().split('T')[0]);
}

function exportSummaryPDF() {
    alert('PDF export functionality would be implemented here using libraries like jsPDF or server-side PDF generation');
}

function printReport() {
    window.print();
}
</script>

<style>
@media print {
    .btn, .card-header, .navbar, footer {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        page-break-inside: avoid;
    }
    
    .row {
        page-break-inside: avoid;
    }
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}AI Face Recognition - Smart Attendance System{% endblock %}

{% block content %}
<!-- ðŸŽ¨ PREMIUM PAGE HEADER -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <div class="fade-in-up">
            <h1 class="display-5 gradient-text mb-3">
                <i class="fas fa-robot me-3"></i>AI Face Recognition
            </h1>
            <p class="lead text-white-50 mb-4">Advanced facial recognition for automated attendance tracking</p>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                <span class="badge bg-success">
                    <i class="fas fa-eye me-1"></i>Real-time Detection
                </span>
                <span class="badge bg-primary">
                    <i class="fas fa-brain me-1"></i>AI Powered
                </span>
                <span class="badge bg-warning">
                    <i class="fas fa-lightning-bolt me-1"></i>Instant Recognition
                </span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ðŸŽ¨ PREMIUM CAMERA FEED -->
    <div class="col-lg-8">
        <div class="card glass glow-effect fade-in-up">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h4 class="gradient-text mb-1">
                        <i class="fas fa-video me-2"></i>Live Camera Feed
                    </h4>
                    <small class="text-muted">AI-powered real-time face detection</small>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button id="startCameraBtn" class="btn btn-primary">
                        <i class="fas fa-video me-2"></i>Start Camera
                    </button>
                    <button id="startFaceRecognitionBtn" class="btn btn-success" disabled>
                        <i class="fas fa-user-check me-2"></i>Start AI
                    </button>
                    <button id="stopBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-stop me-2"></i>Stop All
                    </button>
                    <button id="autoMarkBtn" class="btn btn-warning" disabled>
                        <i class="fas fa-magic me-2"></i>Auto Mark
                    </button>
                </div>
            </div>
            <div class="card-body text-center">
                <div id="cameraContainer" class="position-relative overflow-hidden" style="height: 500px; border-radius: var(--border-radius); background: var(--dark-glass);">
                    <div id="cameraPlaceholder" class="glass d-flex align-items-center justify-content-center h-100">
                        <div class="text-center p-4">
                            <div class="mb-4">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3 floating" 
                                     style="width: 100px; height: 100px; background: var(--primary-gradient);">
                                    <i class="fas fa-camera fa-3x text-white"></i>
                                </div>
                            </div>
                            <h3 class="gradient-text mb-3">AI Camera Ready</h3>
                            <p class="text-muted mb-4">Advanced facial recognition system powered by machine learning</p>
                            
                            <div class="row g-3 text-start">
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-3 rounded-3" style="background: rgba(79, 172, 254, 0.1);">
                                        <i class="fas fa-eye text-primary me-3 fa-lg"></i>
                                        <div>
                                            <strong class="text-primary">Real-time Detection</strong>
                                            <small class="d-block text-muted">Instant face recognition with 99% accuracy</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-3 rounded-3" style="background: rgba(67, 233, 123, 0.1);">
                                        <i class="fas fa-robot text-success me-3 fa-lg"></i>
                                        <div>
                                            <strong class="text-success">AI Powered</strong>
                                            <small class="d-block text-muted">Machine learning algorithms for precision</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-3 rounded-3" style="background: rgba(250, 112, 154, 0.1);">
                                        <i class="fas fa-shield-alt text-danger me-3 fa-lg"></i>
                                        <div>
                                            <strong class="text-danger">Secure & Private</strong>
                                            <small class="d-block text-muted">Data protection with encrypted processing</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <img id="videoFeed" src="" alt="AI Camera Feed" class="position-absolute top-0 start-0 w-100 h-100" 
                         style="display: none; object-fit: cover; border-radius: var(--border-radius);">
                </div>
                
                <!-- Detection Status -->
                <div id="detectionStatus" class="mt-3">
                    <span class="badge bg-secondary">Detection Stopped</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detection Results -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Detected Faces
                </h5>
            </div>
            <div class="card-body">
                <div id="detectedFaces">
                    <div class="text-center text-muted">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <p>Start face recognition to detect students</p>
                    </div>
                </div>
                
                <!-- Manual Attendance Form -->
                <div class="card mt-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-edit me-1"></i>Manual Attendance
                        </h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('mark_manual_attendance') }}" id="manualAttendanceForm">
                            <div class="mb-3">
                                <label class="form-label">Student ID</label>
                                <input type="text" class="form-control" name="student_id" id="studentIdInput" 
                                       placeholder="Enter Student ID" required>
                                <div class="form-text">Enter the student's ID to mark attendance manually</div>
                            </div>
                            <button type="submit" class="btn btn-success btn-sm w-100">
                                <i class="fas fa-check me-1"></i>Mark Present
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Today's Attendance -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Today's Attendance
                </h5>
            </div>
            <div class="card-body">
                <div id="todayAttendance">
                    <div class="text-center text-muted">
                        <i class="fas fa-calendar fa-2x mb-3"></i>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Confirmation Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-user-check fa-3x text-success mb-3"></i>
                    <h4 id="studentName">Student Name</h4>
                    <p>Confidence: <span id="confidenceScore">0%</span></p>
                    <p>Mark this student as present?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmAttendance">Mark Present</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cameraActive = false;
let faceRecognitionActive = false;
let detectionInterval;
let currentStudentId = null;

$(document).ready(function() {
    loadTodayAttendance();
    
    // Start camera
    $('#startCameraBtn').click(function() {
        startCamera();
    });
    
    // Start face recognition
    $('#startFaceRecognitionBtn').click(function() {
        startFaceRecognition();
    });
    
    // Stop all detection
    $('#stopBtn').click(function() {
        stopAllDetection();
    });
    
    // Auto mark attendance
    $('#autoMarkBtn').click(function() {
        autoMarkAttendance();
    });
    
    // Confirm attendance
    $('#confirmAttendance').click(function() {
        if (currentStudentId) {
            markAttendance(currentStudentId);
        }
    });
    
    // Handle manual attendance form
    $('#manualAttendanceForm').on('submit', function(e) {
        const studentId = $('#studentIdInput').val().trim();
        if (!studentId) {
            e.preventDefault();
            showAlert('Please enter a student ID', 'error');
            return;
        }
        
        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>Marking...').prop('disabled', true);
        
        // Reset button after a delay (form will redirect anyway)
        setTimeout(function() {
            submitBtn.html(originalText).prop('disabled', false);
        }, 3000);
    });
    
    // Auto-refresh today's attendance every 30 seconds
    setInterval(loadTodayAttendance, 30000);
});

function startCamera() {
    $.ajax({
        url: '/start_detection',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                cameraActive = true;
                $('#startCameraBtn').prop('disabled', true);
                $('#startFaceRecognitionBtn').prop('disabled', false);
                $('#stopBtn').prop('disabled', false);
                $('#detectionStatus').html('<span class="badge bg-primary">Camera Active</span>');
                
                // Start video feed
                $('#cameraPlaceholder').hide();
                $('#videoFeed').attr('src', '/get_video_feed?' + new Date().getTime()).show();
                
                // Ensure video feed is properly positioned
                $('#videoFeed').css({
                    'max-width': '100%',
                    'height': '500px',
                    'object-fit': 'cover',
                    'border-radius': '10px'
                });
                
                showAlert('Camera started successfully', 'success');
            } else {
                showAlert('Failed to start camera: ' + response.message, 'error');
            }
        },
        error: function() {
            showAlert('Error starting camera', 'error');
        }
    });
}

function startFaceRecognition() {
    $.ajax({
        url: '/start_face_recognition',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                faceRecognitionActive = true;
                $('#startFaceRecognitionBtn').prop('disabled', true);
                $('#autoMarkBtn').prop('disabled', false);
                $('#detectionStatus').html('<span class="badge bg-success">Face Recognition Active</span>');
                
                // Start checking for detected faces
                detectionInterval = setInterval(checkDetectedFaces, 1000);
                
                showAlert(response.message, 'success');
            } else {
                showAlert('Failed to start face recognition: ' + response.message, 'error');
            }
        },
        error: function() {
            showAlert('Error starting face recognition', 'error');
        }
    });
}

function stopAllDetection() {
    // Stop face recognition first
    if (faceRecognitionActive) {
        $.ajax({
            url: '/stop_face_recognition',
            method: 'POST',
            success: function(response) {
                faceRecognitionActive = false;
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                }
            }
        });
    }
    
    // Stop camera
    $.ajax({
        url: '/stop_detection',
        method: 'POST',
        success: function(response) {
            cameraActive = false;
            faceRecognitionActive = false;
            
            // Reset UI
            $('#startCameraBtn').prop('disabled', false);
            $('#startFaceRecognitionBtn').prop('disabled', true);
            $('#stopBtn').prop('disabled', true);
            $('#autoMarkBtn').prop('disabled', true);
            $('#detectionStatus').html('<span class="badge bg-secondary">Detection Stopped</span>');
            
            // Stop video feed
            $('#videoFeed').attr('src', '').hide();
            $('#cameraPlaceholder').show();
            
            // Clear detected faces
            $('#detectedFaces').html(`
                <div class="text-center text-muted">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <p>Start face recognition to detect students</p>
                </div>
            `);
            
            // Stop checking for faces
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }
            
            showAlert('All detection stopped', 'info');
        },
        error: function() {
            showAlert('Error stopping detection', 'error');
        }
    });
}

function autoMarkAttendance() {
    if (!faceRecognitionActive) {
        showAlert('Face recognition is not active', 'error');
        return;
    }
    
    $.ajax({
        url: '/auto_mark_attendance',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                loadTodayAttendance();
                
                // Show marked students
                if (response.marked_students && response.marked_students.length > 0) {
                    let studentsList = response.marked_students.map(s => 
                        `${s.name} (${s.status})`
                    ).join(', ');
                    showAlert(`Marked: ${studentsList}`, 'info');
                }
            } else {
                showAlert(response.message, 'warning');
            }
        },
        error: function() {
            showAlert('Error in auto attendance marking', 'error');
        }
    });
}

function checkDetectedFaces() {
    if (!faceRecognitionActive) return;
    
    $.get('/get_detected_faces', function(data) {
        if (data.faces && data.faces.length > 0) {
            displayDetectedFaces(data.faces);
        } else {
            $('#detectedFaces').html(`
                <div class="text-center text-muted">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <p>Scanning for faces...</p>
                </div>
            `);
        }
    });
}

function displayDetectedFaces(faces) {
    let html = '';
    
    faces.forEach(function(face) {
        if (face.student_id) {
            html += `
                <div class="card mb-2 border-success">
                    <div class="card-body p-2">
                        <h6 class="card-title text-success mb-1">
                            <i class="fas fa-user-check me-1"></i>${face.name}
                        </h6>
                        <small class="text-muted">
                            Confidence: ${(face.confidence * 100).toFixed(1)}%
                        </small>
                        <div class="mt-2">
                            <button class="btn btn-success btn-sm w-100" onclick="showAttendanceModal(${face.student_id}, '${face.name}', ${face.confidence})">
                                Mark Present
                            </button>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="card mb-2 border-warning">
                    <div class="card-body p-2">
                        <h6 class="card-title text-warning mb-1">
                            <i class="fas fa-user-times me-1"></i>Unknown Face
                        </h6>
                        <small class="text-muted">Not registered</small>
                    </div>
                </div>
            `;
        }
    });
    
    $('#detectedFaces').html(html);
}

function showAttendanceModal(studentId, studentName, confidence) {
    currentStudentId = studentId;
    $('#studentName').text(studentName);
    $('#confidenceScore').text((confidence * 100).toFixed(1) + '%');
    $('#attendanceModal').modal('show');
}

function markAttendance(studentId) {
    $.ajax({
        url: '/mark_student_present',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            student_id: studentId,
            confidence: parseFloat($('#confidenceScore').text()) / 100
        }),
        success: function(response) {
            $('#attendanceModal').modal('hide');
            
            if (response.success) {
                showAlert(`${response.student_name} marked ${response.status.toLowerCase()} at ${response.time}`, 'success');
                loadTodayAttendance();
            } else {
                showAlert(response.message, 'warning');
            }
        },
        error: function() {
            $('#attendanceModal').modal('hide');
            showAlert('Error marking attendance', 'error');
        }
    });
}

function loadTodayAttendance() {
    $.get('/api/today_attendance', function(data) {
        let html = `
            <div class="text-center mb-3">
                <h5 class="text-primary">${new Date().toLocaleDateString()}</h5>
                <span class="badge bg-success">${data.total_present} Present</span>
            </div>
        `;
        
        if (data.records && data.records.length > 0) {
            html += '<div class="list-group list-group-flush">';
            data.records.forEach(function(record) {
                const statusClass = record.status === 'Present' ? 'success' : 
                                  record.status === 'Late' ? 'warning' : 'secondary';
                html += `
                    <div class="list-group-item p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="fw-bold">${record.student_name}</small><br>
                                <small class="text-muted">${record.student_id}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${statusClass}">${record.status}</span><br>
                                <small class="text-muted">${record.time}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        } else {
            html += '<p class="text-muted text-center">No attendance marked today</p>';
        }
        
        html += `
            <div class="text-center mt-3">
                <a href="/attendance?date=${data.date}" class="btn btn-sm btn-outline-primary">
                    View All Records
                </a>
            </div>
        `;
        
        $('#todayAttendance').html(html);
    }).fail(function() {
        $('#todayAttendance').html(`
            <div class="text-center text-muted">
                <p>Error loading attendance data</p>
            </div>
        `);
    });
}

function showAlert(message, type) {
    const alertClass = type === 'error' ? 'danger' : type;
    const alertHtml = `
        <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Remove existing alerts
    $('.alert').remove();
    
    // Add new alert at the top of the container
    $('.container').first().prepend(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}

// Cleanup on page unload
$(window).on('beforeunload', function() {
    if (cameraActive || faceRecognitionActive) {
        stopAllDetection();
    }
});
</script>
{% endblock %}
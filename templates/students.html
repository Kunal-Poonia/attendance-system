{% extends "base.html" %}

{% block title %}Students - Smart Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-users me-2"></i>Students
            </h1>
            <a href="{{ url_for('register_student') }}" class="btn btn-primary">
                <i class="fas fa-user-plus me-1"></i>Register New Student
            </a>
        </div>
    </div>
</div>

<!-- Students List -->
<div class="row">
    <div class="col-12">
        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filters
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                                <option value="{{ dept }}" {{ 'selected' if dept == current_department else '' }}>
                                    {{ dept }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="course" class="form-label">Course</label>
                        <select class="form-select" id="course" name="course">
                            <option value="">All Courses</option>
                            {% for course in courses %}
                                <option value="{{ course }}" {{ 'selected' if course == current_course else '' }}>
                                    {{ course }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="">All Years</option>
                            {% for yr in years %}
                                <option value="{{ yr }}" {{ 'selected' if yr == current_year else '' }}>
                                    {{ yr }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="section" class="form-label">Section</label>
                        <select class="form-select" id="section" name="section">
                            <option value="">All Sections</option>
                            {% for sec in sections %}
                                <option value="{{ sec }}" {{ 'selected' if sec == current_section else '' }}>
                                    {{ sec }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="show_inactive" name="show_inactive" 
                                   value="true" {{ 'checked' if show_inactive else '' }}>
                            <label class="form-check-label" for="show_inactive">
                                Show Inactive Students
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>Filter
                        </button>
                        <a href="{{ url_for('students') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    Students ({{ students|length }})
                    {% if show_inactive %}
                        <span class="badge bg-secondary ms-2">Including Inactive</span>
                    {% endif %}
                </h5>
                <div class="input-group" style="width: 300px;">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search students...">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if students %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Department</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>Section</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr>
                                    <td>
                                        {% if student.image_path %}
                                            <img src="/{{ student.image_path }}" 
                                                 alt="{{ student.name }}" 
                                                 class="rounded-circle" 
                                                 style="width: 40px; height: 40px; object-fit: cover;"
                                                 onerror="this.src='/static/images/default-avatar.svg'">
                                        {% else %}
                                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ student.student_id }}</strong>
                                    </td>
                                    <td>{{ student.name }}</td>
                                    <td>
                                        <a href="mailto:{{ student.email }}">{{ student.email }}</a>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ student.department or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ student.course or 'N/A' }}</span>
                                    </td>
                                    <td>{{ student.year or 'N/A' }}</td>
                                    <td>{{ student.section or 'N/A' }}</td>
                                    <td>
                                        {% if student.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" 
                                                    onclick="viewStudent({{ student.id }})" 
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                                {% if student.is_active %}
                                                    <button type="button" class="btn btn-outline-warning" 
                                                            onclick="editStudent({{ student.id }})" 
                                                            title="Edit Student">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" 
                                                            onclick="deleteStudent({{ student.id }}, '{{ student.name }}')" 
                                                            title="Deactivate Student">
                                                        <i class="fas fa-user-slash"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" 
                                                            onclick="permanentlyDeleteStudent({{ student.id }}, '{{ student.name }}')" 
                                                            title="Permanently Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% else %}
                                                    <button type="button" class="btn btn-outline-success" 
                                                            onclick="reactivateStudent({{ student.id }}, '{{ student.name }}')" 
                                                            title="Reactivate Student">
                                                        <i class="fas fa-user-check"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" 
                                                            onclick="permanentlyDeleteStudent({{ student.id }}, '{{ student.name }}')" 
                                                            title="Permanently Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Students Registered</h4>
                        <p class="text-muted mb-4">Start by registering your first student</p>
                        <a href="{{ url_for('register_student') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-user-plus me-2"></i>Register First Student
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentDetails">
                <!-- Student details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>Are you sure?</h4>
                    <p>Do you want to delete student <strong id="deleteStudentName"></strong>?</p>
                    <p class="text-muted">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Student</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStudentId = null;

$(document).ready(function() {
    // Search functionality
    $('#searchInput').on('keyup', function() {
        const value = $(this).val().toLowerCase();
        $('#studentsTable tbody tr').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    });
    
    // Confirm delete
    $('#confirmDelete').click(function() {
        if (currentStudentId) {
            $.ajax({
                url: `/delete_student/${currentStudentId}`,
                method: 'POST',
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload(); // Refresh the page
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('Error deleting student');
                }
            });
            $('#deleteModal').modal('hide');
        }
    });
});

function viewStudent(studentId) {
    // Load student details
    $.get(`/api/student/${studentId}`, function(data) {
        let html = `
            <div class="row">
                <div class="col-md-4 text-center">
                    ${data.image_path ? 
                        `<img src="/${data.image_path}" 
                              alt="${data.name}" 
                              class="img-fluid rounded-circle mb-3" 
                              style="width: 150px; height: 150px; object-fit: cover;"
                              onerror="this.src='/static/images/default-avatar.svg'">` :
                        `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                              style="width: 150px; height: 150px;">
                            <i class="fas fa-user fa-3x text-white"></i>
                         </div>`
                    }
                    <h4>${data.name}</h4>
                    <p class="text-muted">${data.student_id}</p>
                </div>
                <div class="col-md-8">
                    <table class="table table-borderless">
                        <tr>
                            <th width="30%">Email:</th>
                            <td><a href="mailto:${data.email}">${data.email}</a></td>
                        </tr>
                        <tr>
                            <th>Phone:</th>
                            <td>${data.phone || 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Roll Number:</th>
                            <td>${data.roll_number || 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Department:</th>
                            <td><span class="badge bg-primary">${data.department || 'N/A'}</span></td>
                        </tr>
                        <tr>
                            <th>Course:</th>
                            <td><span class="badge bg-info">${data.course || 'N/A'}</span></td>
                        </tr>
                        <tr>
                            <th>Year:</th>
                            <td>${data.year || 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Section:</th>
                            <td>${data.section || 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Semester:</th>
                            <td>${data.semester || 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Batch:</th>
                            <td>${data.batch || 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td><span class="badge bg-${data.is_active ? 'success' : 'secondary'}">${data.is_active ? 'Active' : 'Inactive'}</span></td>
                        </tr>
                        <tr>
                            <th>Registered:</th>
                            <td>${data.created_at ? new Date(data.created_at).toLocaleDateString() : 'N/A'}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        
        $('#studentDetails').html(html);
        $('#studentModal').modal('show');
    }).fail(function() {
        alert('Error loading student details');
    });
}

function editStudent(studentId) {
    // Redirect to edit form
    window.location.href = `/edit_student/${studentId}`;
}

function deleteStudent(studentId, studentName) {
    currentStudentId = studentId;
    $('#deleteStudentName').text(studentName);
    $('#deleteModal .modal-title').text('Deactivate Student');
    $('#deleteModal .modal-body p').html(`Do you want to deactivate student <strong>${studentName}</strong>?<br><small class="text-muted">This will preserve all attendance records.</small>`);
    $('#confirmDelete').text('Deactivate Student').removeClass('btn-danger').addClass('btn-warning');
    $('#deleteModal').modal('show');
}

function reactivateStudent(studentId, studentName) {
    if (confirm(`Reactivate student ${studentName}?`)) {
        $.ajax({
            url: `/reactivate_student/${studentId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error reactivating student');
            }
        });
    }
}

function permanentlyDeleteStudent(studentId, studentName) {
    if (confirm(`PERMANENTLY DELETE student ${studentName} and ALL attendance records?\n\nThis action CANNOT be undone!`)) {
        $.ajax({
            url: `/permanently_delete_student/${studentId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error permanently deleting student');
            }
        });
    }
}


</script>
{% endblock %}
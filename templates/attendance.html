{% extends "base.html" %}

{% block title %}Attendance Records - Smart Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-list me-2"></i>Attendance Records
            </h1>
            <div class="btn-group" role="group">
                <a href="{{ url_for('mark_attendance') }}" class="btn btn-success">
                    <i class="fas fa-user-check me-1"></i>Mark Attendance
                </a>
                <button class="btn btn-info" onclick="alert('Export feature coming soon!')">
                    <i class="fas fa-file-csv me-1"></i>Export CSV
                </button>
                <button class="btn btn-primary" onclick="alert('Export feature coming soon!')">
                    <i class="fas fa-file-excel me-1"></i>Export Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filters
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-2">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" 
                               value="{{ current_date }}">
                    </div>
                    <div class="col-md-2">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                                <option value="{{ dept }}" {{ 'selected' if dept == current_department else '' }}>
                                    {{ dept }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="course" class="form-label">Course</label>
                        <select class="form-select" id="course" name="course">
                            <option value="">All Courses</option>
                            {% for course in courses %}
                                <option value="{{ course }}" {{ 'selected' if course == current_course else '' }}>
                                    {{ course }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="">All</option>
                            {% for yr in years %}
                                <option value="{{ yr }}" {{ 'selected' if yr == current_year else '' }}>
                                    {{ yr }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label for="section" class="form-label">Section</label>
                        <select class="form-select" id="section" name="section">
                            <option value="">All</option>
                            {% for sec in sections %}
                                <option value="{{ sec }}" {{ 'selected' if sec == current_section else '' }}>
                                    {{ sec }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="subject" class="form-label">Subject</label>
                        <select class="form-select" id="subject" name="subject">
                            <option value="">All Subjects</option>
                            {% for subj in subjects %}
                                <option value="{{ subj }}" {{ 'selected' if subj == current_subject else '' }}>
                                    {{ subj }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>Filter
                        </button>
                        <a href="{{ url_for('attendance') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Records -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    Attendance Records 
                    {% if current_date %}
                        - {{ current_date }}
                    {% endif %}
                    ({{ records|length }} records)
                </h5>
                <div class="input-group" style="width: 300px;">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search records...">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if records %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Course</th>
                                    <th>Year</th>
                                    <th>Section</th>
                                    <th>Subject</th>
                                    <th>Date</th>
                                    <th>Time In</th>
                                    <th>Status</th>
                                    <th>Marked By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in records %}
                                <tr>
                                    <td>
                                        <strong>{{ record.student.student_id if record.student else 'N/A' }}</strong>
                                    </td>
                                    <td>{{ record.student.name if record.student else 'N/A' }}</td>
                                    <td>
                                        {% if record.student and record.student.department %}
                                            <span class="badge bg-primary">{{ record.student.department }}</span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.student and record.student.course %}
                                            <span class="badge bg-info">{{ record.student.course }}</span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ record.student.year if record.student else 'N/A' }}</td>
                                    <td>{{ record.student.section if record.student else 'N/A' }}</td>
                                    <td>
                                        {% if record.subject %}
                                            <span class="badge bg-secondary">{{ record.subject }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ record.date.strftime('%Y-%m-%d') if record.date else 'N/A' }}</td>
                                    <td>
                                        {% if record.time_in %}
                                            <span class="text-success">
                                                <i class="fas fa-clock me-1"></i>
                                                {{ record.time_in.strftime('%H:%M:%S') }}
                                            </span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm status-select" 
                                                data-record-id="{{ record.id }}" 
                                                onchange="updateStatus(this)">
                                            <option value="Present" {{ 'selected' if record.status == 'Present' else '' }}>Present</option>
                                            <option value="Absent" {{ 'selected' if record.status == 'Absent' else '' }}>Absent</option>
                                            <option value="Late" {{ 'selected' if record.status == 'Late' else '' }}>Late</option>
                                            <option value="Excused" {{ 'selected' if record.status == 'Excused' else '' }}>Excused</option>
                                        </select>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if record.marked_by == 'System' else 'secondary' }}">
                                            {{ record.marked_by or 'System' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" 
                                                    onclick="viewRecord({{ record.id }})" 
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if not record.time_out %}
                                                <button type="button" class="btn btn-outline-warning" 
                                                        onclick="markTimeOut({{ record.id }})" 
                                                        title="Mark Time Out">
                                                    <i class="fas fa-sign-out-alt"></i>
                                                </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-outline-danger" 
                                                    onclick="deleteRecord({{ record.id }})" 
                                                    title="Delete Record">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ records|selectattr('status', 'equalto', 'Present')|list|length }}</h4>
                                    <p class="mb-0">Present</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4>{{ records|selectattr('status', 'equalto', 'Late')|list|length }}</h4>
                                    <p class="mb-0">Late</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h4>{{ records|selectattr('status', 'equalto', 'Absent')|list|length }}</h4>
                                    <p class="mb-0">Absent</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ records|length }}</h4>
                                    <p class="mb-0">Total</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Attendance Records Found</h4>
                        <p class="text-muted mb-4">
                            {% if current_date or current_department or current_year %}
                                Try adjusting your filters or 
                                <a href="{{ url_for('attendance') }}">clear all filters</a>
                            {% else %}
                                Start marking attendance to see records here
                            {% endif %}
                        </p>
                        <a href="{{ url_for('mark_attendance') }}" class="btn btn-primary btn-lg">
                            <i class="fas fa-camera me-2"></i>Mark Attendance
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Record Details Modal -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Attendance Record Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recordDetails">
                <!-- Record details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Search functionality
    $('#searchInput').on('keyup', function() {
        const value = $(this).val().toLowerCase();
        $('#attendanceTable tbody tr').filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
    });
    
    // Set today's date as default
    if (!$('#date').val()) {
        $('#date').val(new Date().toISOString().split('T')[0]);
    }
    
    // Initialize status select styling
    $('.status-select').each(function() {
        const status = $(this).val();
        const element = this;
        
        // Store original status
        element.setAttribute('data-original-status', status);
        
        // Apply initial styling
        if (status === 'Present') {
            element.style.backgroundColor = '#d4edda';
            element.style.color = '#155724';
            element.style.border = '1px solid #c3e6cb';
        } else if (status === 'Absent') {
            element.style.backgroundColor = '#f8d7da';
            element.style.color = '#721c24';
            element.style.border = '1px solid #f5c6cb';
        } else if (status === 'Late') {
            element.style.backgroundColor = '#fff3cd';
            element.style.color = '#856404';
            element.style.border = '1px solid #ffeaa7';
        } else if (status === 'Excused') {
            element.style.backgroundColor = '#d1ecf1';
            element.style.color = '#0c5460';
            element.style.border = '1px solid #bee5eb';
        }
    });
});

function viewRecord(recordId) {
    // In a real application, you would load record details via AJAX
    let html = `
        <div class="text-center">
            <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
            <h4>Record Details</h4>
            <p>Detailed view for record ID: ${recordId}</p>
            <p class="text-muted">This would show complete attendance record information</p>
        </div>
    `;
    
    $('#recordDetails').html(html);
    $('#recordModal').modal('show');
}

function markTimeOut(recordId) {
    if (confirm('Mark time out for this student?')) {
        $.ajax({
            url: `/mark_time_out/${recordId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload(); // Refresh to show updated time
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error marking time out');
            }
        });
    }
}

function updateStatus(selectElement) {
    const recordId = selectElement.getAttribute('data-record-id');
    const newStatus = selectElement.value;
    const originalStatus = selectElement.getAttribute('data-original-status') || selectElement.value;
    
    if (confirm(`Change attendance status to "${newStatus}"?`)) {
        $.ajax({
            url: '/update_attendance_status',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                record_id: recordId,
                status: newStatus
            }),
            success: function(response) {
                if (response.success) {
                    // Update the select element styling based on new status
                    selectElement.className = 'form-select form-select-sm status-select';
                    if (newStatus === 'Present') {
                        selectElement.style.backgroundColor = '#d4edda';
                        selectElement.style.color = '#155724';
                    } else if (newStatus === 'Absent') {
                        selectElement.style.backgroundColor = '#f8d7da';
                        selectElement.style.color = '#721c24';
                    } else if (newStatus === 'Late') {
                        selectElement.style.backgroundColor = '#fff3cd';
                        selectElement.style.color = '#856404';
                    } else if (newStatus === 'Excused') {
                        selectElement.style.backgroundColor = '#d1ecf1';
                        selectElement.style.color = '#0c5460';
                    }
                    
                    // Show success message
                    showAlert('success', response.message);
                } else {
                    // Revert to original status
                    selectElement.value = originalStatus;
                    showAlert('error', 'Error: ' + response.message);
                }
            },
            error: function() {
                // Revert to original status
                selectElement.value = originalStatus;
                showAlert('error', 'Error updating status');
            }
        });
    } else {
        // Revert to original status if cancelled
        selectElement.value = originalStatus;
    }
}

function deleteRecord(recordId) {
    if (confirm('Are you sure you want to delete this attendance record? This action cannot be undone.')) {
        $.ajax({
            url: `/delete_attendance/${recordId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    // Remove the row from the table
                    $(`button[onclick="deleteRecord(${recordId})"]`).closest('tr').fadeOut(300, function() {
                        $(this).remove();
                        updateSummaryStats();
                    });
                } else {
                    showAlert('error', 'Error: ' + response.message);
                }
            },
            error: function() {
                showAlert('error', 'Error deleting record');
            }
        });
    }
}

function showAlert(type, message) {
    // Create alert element
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insert at the top of the page
    $('.row').first().before(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}

function updateSummaryStats() {
    // Recalculate and update summary statistics
    const rows = $('#attendanceTable tbody tr:visible');
    let presentCount = 0, absentCount = 0, lateCount = 0, excusedCount = 0;
    
    rows.each(function() {
        const status = $(this).find('.status-select').val();
        if (status === 'Present') presentCount++;
        else if (status === 'Absent') absentCount++;
        else if (status === 'Late') lateCount++;
        else if (status === 'Excused') excusedCount++;
    });
    
    // Update summary cards (if they exist)
    $('.card.bg-success h4').text(presentCount);
    $('.card.bg-danger h4').text(absentCount);
    $('.card.bg-warning h4').text(lateCount);
    $('.card.bg-info h4').text(rows.length);
}
</script>
{% endblock %}
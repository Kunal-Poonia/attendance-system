{% extends "base.html" %}

{% block title %}Mark Present - Smart Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-user-check me-2"></i>Mark Students Present
            </h1>
            <div class="btn-group" role="group">
                <a href="{{ url_for('attendance') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Attendance
                </a>
                <a href="{{ url_for('mark_absent') }}" class="btn btn-warning">
                    <i class="fas fa-user-times me-1"></i>Mark Absent
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Mark Students as Present
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="markPresentForm">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="date" name="date" 
                                   value="{{ date.today().isoformat() }}" required>
                        </div>
                        <div class="col-md-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="subject" name="subject">
                        </div>
                        <div class="col-md-3">
                            <label for="class_period" class="form-label">Class Period</label>
                            <select class="form-select" id="class_period" name="class_period">
                                <option value="" disabled selected style="display: none;">Choose Period</option>
                                <option value="1st Period">1st Period</option>
                                <option value="2nd Period">2nd Period</option>
                                <option value="3rd Period">3rd Period</option>
                                <option value="4th Period">4th Period</option>
                                <option value="5th Period">5th Period</option>
                                <option value="6th Period">6th Period</option>
                                <option value="7th Period">7th Period</option>
                                <option value="8th Period">8th Period</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="teacher_name" class="form-label">Teacher Name</label>
                            <input type="text" class="form-control" id="teacher_name" name="teacher_name">
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="remarks" class="form-label">Remarks</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="2" 
                                      placeholder="Optional remarks or notes"></textarea>
                        </div>
                    </div>

                    <!-- Student Filters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Filter Students</h6>
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <select class="form-select" id="filterDepartment" onchange="filterStudents()">
                                                <option value="" selected>All Departments</option>
                                                {% for dept in departments %}
                                                    <option value="{{ dept }}">{{ dept }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="filterCourse" onchange="filterStudents()">
                                                <option value="" selected>All Courses</option>
                                                {% for course in courses %}
                                                    <option value="{{ course }}">{{ course }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" id="filterYear" onchange="filterStudents()">
                                                <option value="" selected>All Years</option>
                                                {% for year in years %}
                                                    <option value="{{ year }}">{{ year }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select" id="filterSection" onchange="filterStudents()">
                                                <option value="" selected>All Sections</option>
                                                {% for section in sections %}
                                                    <option value="{{ section }}">{{ section }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" class="form-control" id="searchStudent" 
                                                   placeholder="Search name..." onkeyup="filterStudents()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Selection -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Select Students to Mark Present</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="selectAll()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="selectNone()">
                                        <i class="fas fa-square me-1"></i>Select None
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" 
                                                       onchange="toggleAll(this)">
                                            </th>
                                            <th>Student ID</th>
                                            <th>Name</th>
                                            <th>Department</th>
                                            <th>Course</th>
                                            <th>Year</th>
                                            <th>Section</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        {% for student in students %}
                                        <tr class="student-row" 
                                            data-department="{{ student.department }}"
                                            data-course="{{ student.course }}"
                                            data-year="{{ student.year }}"
                                            data-section="{{ student.section }}"
                                            data-name="{{ student.name.lower() }}">
                                            <td>
                                                <input type="checkbox" class="form-check-input student-checkbox" 
                                                       name="student_ids" value="{{ student.id }}">
                                            </td>
                                            <td><strong>{{ student.student_id }}</strong></td>
                                            <td>{{ student.name }}</td>
                                            <td>
                                                <span class="badge bg-primary">{{ student.department }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ student.course }}</span>
                                            </td>
                                            <td>{{ student.year }}</td>
                                            <td>{{ student.section }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <span id="selectedCount">0</span> students selected out of 
                                    <span id="totalVisible">{{ students|length }}</span> visible students
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-end gap-2">
                                <a href="{{ url_for('attendance') }}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-success" id="submitBtn">
                                    <i class="fas fa-check me-1"></i>Mark Selected as Present
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    updateCounts();
    
    // Update counts when checkboxes change
    $('.student-checkbox').on('change', function() {
        updateCounts();
        updateSelectAllCheckbox();
    });
});

function filterStudents() {
    const department = $('#filterDepartment').val().toLowerCase();
    const course = $('#filterCourse').val().toLowerCase();
    const year = $('#filterYear').val().toLowerCase();
    const section = $('#filterSection').val().toLowerCase();
    const search = $('#searchStudent').val().toLowerCase();
    
    let visibleCount = 0;
    
    $('.student-row').each(function() {
        const row = $(this);
        const rowDept = row.data('department').toLowerCase();
        const rowCourse = row.data('course').toLowerCase();
        const rowYear = row.data('year').toString().toLowerCase();
        const rowSection = row.data('section').toLowerCase();
        const rowName = row.data('name');
        
        let show = true;
        
        if (department && !rowDept.includes(department)) show = false;
        if (course && !rowCourse.includes(course)) show = false;
        if (year && !rowYear.includes(year)) show = false;
        if (section && !rowSection.includes(section)) show = false;
        if (search && !rowName.includes(search)) show = false;
        
        if (show) {
            row.show();
            visibleCount++;
        } else {
            row.hide();
            row.find('.student-checkbox').prop('checked', false);
        }
    });
    
    $('#totalVisible').text(visibleCount);
    updateCounts();
    updateSelectAllCheckbox();
}

function selectAll() {
    $('.student-row:visible .student-checkbox').prop('checked', true);
    updateCounts();
    updateSelectAllCheckbox();
}

function selectNone() {
    $('.student-checkbox').prop('checked', false);
    updateCounts();
    updateSelectAllCheckbox();
}

function toggleAll(checkbox) {
    $('.student-row:visible .student-checkbox').prop('checked', checkbox.checked);
    updateCounts();
}

function updateCounts() {
    const selectedCount = $('.student-checkbox:checked').length;
    $('#selectedCount').text(selectedCount);
    
    // Enable/disable submit button
    $('#submitBtn').prop('disabled', selectedCount === 0);
}

function updateSelectAllCheckbox() {
    const visibleCheckboxes = $('.student-row:visible .student-checkbox');
    const checkedVisible = $('.student-row:visible .student-checkbox:checked');
    
    if (visibleCheckboxes.length === 0) {
        $('#selectAllCheckbox').prop('indeterminate', false).prop('checked', false);
    } else if (checkedVisible.length === visibleCheckboxes.length) {
        $('#selectAllCheckbox').prop('indeterminate', false).prop('checked', true);
    } else if (checkedVisible.length > 0) {
        $('#selectAllCheckbox').prop('indeterminate', true);
    } else {
        $('#selectAllCheckbox').prop('indeterminate', false).prop('checked', false);
    }
}

// Form validation
$('#markPresentForm').on('submit', function(e) {
    const selectedCount = $('.student-checkbox:checked').length;
    
    if (selectedCount === 0) {
        e.preventDefault();
        alert('Please select at least one student to mark as present.');
        return false;
    }
    
    return confirm(`Mark ${selectedCount} student(s) as present?`);
});
</script>
{% endblock %}